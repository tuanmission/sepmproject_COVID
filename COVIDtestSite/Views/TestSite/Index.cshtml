
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h1>Index</h1>

    <div class="table-responsive">
        <table class="table table-hover" id="testtable">
            <thead class="thead-dark">
                <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Address</th>
                    <th scope="col">Test Site Type</th>
                    <th scope="col">View Details</th>
                </tr>

            </thead>
            <tbody>
                <tr></tr>
            </tbody>

        </table>
    </div>
<br>

<h1 class="text-center">Test Site Map</h1>

<div class="row">
    <div id="map" style="width: 100%; height: 300px" >

    </div>
</div>
<div class="row">
    <div class="col-md-2 float-md-right" id="currentlocationdiv">

    </div>
    <div id="error"></div>
</div>




@section Scripts{
    <script>
        $(document).ready(function () {
            
            var table = $("#testtable").DataTable({
                ajax: {

                    url: "/api/TestSite/",
                    dataSrc: "",

                },
                columns: [
                    {
                        data: "testSiteName"
                    },
                    {
                        data: "address"
                    },
                    {
                        data: "testsiteType.typeName"

                    },
                    {

                        data: "id",
                        render: function (data) {
                            return "<a href='/TestSite/details/" + data + "' class='btn btn-primary'>View Details</a>";
                        }

                    }

                ]

            });

            
            
            
            
            document.getElementById('error').innerHTML = "";
            var lat = -37.81835264597926;
            var lon = 144.96380671984414;
            loadTestSitesonMap(lat, lon);

        });

        function loadTestSitesonMap(latitude, longitude) {
            $.ajax({
                type: "GET",
                url: "/api/TestSite/",
                dataType: "json",
            }).done(function (data) {

                var map = loadmap(latitude, longitude);

                for (var mapdata of data) {
                    var position = { lat: mapdata.latitude, lng: mapdata.longitude };
                    var params = { id: mapdata.id, waittime: mapdata.waitingTime, name: mapdata.testSiteName, address: mapdata.address };
                    addMarkers(position, map, params);
                }

                var centerdiv = document.getElementById('currentlocationdiv');
                centerdiv.innerHTML = `<button class="btn btn-primary" onclick="currentLocation()">Use my Location</button>`;


            }).fail(function () {
                document.getElementById('error').innerHTML = ` <div class="alert alert-danger">Failed to Get Test Site Data</div>`;
            });
        }

        function loadmap(latitude, longitude) {
            var myLatLng = {
                lat: latitude,
                lng: longitude,
            };
            var mapProp = {
                center: new google.maps.LatLng(latitude, longitude),
                zoom: 15,
            };
            var map = new google.maps.Map(
                document.getElementById("map"),
                mapProp
            );

            new google.maps.Marker({
                position: myLatLng,
                map,
                title: "Hello World!",
            });

            return map;
        }

        function addMarkers(pos, mp, params) {
           const marker= new google.maps.Marker({
                position: pos,
                map:mp,
                title: "Hello World!",
           });

            var windowString = `
          <h4>`+ params.name + `</h4>
          <p>`+ params.address + `</p>
          <p>Waiting Time: `+ params.waittime + `</p>
          <a href="/TestSite/details/`+ params.id + `" class="btn btn-primary">Details</a>
           `;
            const infowindow = new google.maps.InfoWindow({
                content: windowString,
            });

            marker.addListener("click", () => {
                infowindow.open({
                    anchor: marker,
                    map:mp,
                    shouldFocus: false,
                });
            });
        }

        function currentLocation() {
            var error = document.getElementById('error');
            error.innerHTML = "";
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(centermap);
            } else {
               
                error.innerHTML = `<div class="alert alert-danger">Failed to Get current Position</div>`;
            }
            
        }

        function centermap(position) {
           
            var longi = parseFloat(position.coords.longitude);
            var lati = parseFloat(position.coords.latitude);
            var mapProp = {
                center: new google.maps.LatLng(lati, longi),
                zoom: 15,
            };
            var map = new google.maps.Map(
                document.getElementById("map"),
                mapProp
            );

            new google.maps.Marker({
                position: new google.maps.LatLng(lati, longi),
                map,
                title: "Hello World!",
            });
            $.ajax({
                type: "GET",
                url: "/api/TestSite/",
                dataType: "json",
            }).done(function (data) {


                for (var mapdata of data) {
                    var position = { lat: mapdata.latitude, lng: mapdata.longitude };
                    var params = { id: mapdata.id, waittime: mapdata.waitingTime, name: mapdata.testSiteName, address: mapdata.address };
                    addMarkers(position, map, params);
                }

                

            }).fail(function () {
                document.getElementById('error').innerHTML = ` <div class="alert alert-danger">Failed to Get Test Site Data</div>`;
            });
            
            
        }
            
            
            
            
            
            
            
      

        

    </script>

}

